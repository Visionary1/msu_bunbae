<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapleStory Boss Reward Tracker</title>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.07);
            padding: 40px 32px 32px 32px;
        }
        .header {
            padding: 0 0 32px 0;
            text-align: left;
            color: #222;
        }
        .header h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        .header p {
            font-size: 1.2em;
            color: #888;
            margin-top: 0;
        }
        .room-section {
            padding: 0 0 32px 0;
            background: none;
            border-bottom: 1px solid #ececec;
        }
        .room-controls {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 32px;
            align-items: stretch;
        }
        .room-controls > * {
            width: 100%;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
            height: 56px;
            margin: 0;
        }
        .room-controls .input-group {
            margin-bottom: 0;
            height: 100%;
            justify-content: flex-end;
        }
        .room-controls .input-group label {
            margin-bottom: 4px;
        }
        .room-controls .btn,
        .room-controls .btn-primary,
        .room-controls .btn-success {
            height: 56px;
            padding-top: 0;
            padding-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            border-radius: 14px;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            background: #fafbfc;
            transition: border-color 0.2s, box-shadow 0.2s;
            height: 44px;
            margin-bottom: 0;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #007aff;
            background: #fff;
            box-shadow: 0 0 0 2px #007aff22;
        }
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            background: #f5f6fa;
            color: #222;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .btn-primary {
            background: #007aff;
            color: #fff;
            width: 100%;
            display: block;
            margin-bottom: 24px;
        }
        .btn-primary:hover {
            background: #005ecb;
        }
        .btn-success {
            background: #34c759;
            color: #fff;
        }
        .btn-success:hover {
            background: #28a745;
        }
        .room-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #007aff;
            margin-bottom: 0;
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            border-radius: 20px;
            color: #fff;
            font-weight: 600;
            z-index: 1000;
            font-size: 1em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .status-connected {
            background: #34c759;
        }
        .status-disconnected {
            background: #ff3b30;
        }
        .main-content {
            padding: 30px;
        }
        .boss-selection {
            margin-bottom: 30px;
        }
        .boss-grid {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-top: 20px;
        }
        .boss-row {
            display: grid;
            align-items: center;
            gap: 0 32px;
            margin-bottom: 0;
            width: 100%;
        }
        .boss-starbox {
            display: flex;
            align-items: center;
            min-width: 90px;
            padding: 0 0 0 2px;
            background: none;
        }
        .boss-starbox .boss-star {
            color: #A78B5C;
            font-size: 1.5em;
            margin-right: 2px;
        }
        .boss-row .boss-name, .boss-row .boss-name-empty {
            min-width: 0;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            justify-self: start;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .boss-row .boss-name-empty {
            background: none;
            border: none;
            box-shadow: none;
            cursor: default;
        }
        .boss-names {
            display: flex;
            flex-wrap: wrap;
            gap: 24px 32px;
        }
        .boss-name {
            font-size: 1.18em;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s, background 0.2s, border 0.2s;
            padding: 14px 24px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .boss-name.selected {
            color: #28a745;
            background: #eafbe7;
            border: 2px solid #28a745;
        }
        .boss-name.unselected {
            color: #e53935;
            background: none;
            border: 2px solid #e0e0e0;
        }
        .boss-details {
            margin-top: 30px;
            display: none;
        }
        .boss-details.active {
            display: block;
        }
        .boss-section {
            background: white;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid #dee2e6;
        }
        .boss-header {
            background: linear-gradient(45deg, #FF6B6B, #FFE66D);
            padding: 20px;
            color: white;
            margin-bottom: 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        .boss-header:hover {
            background: linear-gradient(45deg, #ff5252, #ffd54f);
        }
        .boss-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        .boss-toggle {
            font-size: 1.2em;
            transition: transform 0.3s;
        }
        .boss-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        .boss-content.collapsed {
            max-height: 0;
        }
        .boss-content.expanded {
            max-height: none;
        }
        .party-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .party-member {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 32px;
            border: 2px solid #dee2e6;
        }
        .member-info {
            display: grid;
            grid-template-columns: 1fr 1fr 100px;
            gap: 15px;
            margin-bottom: 15px;
        }
        .reward-input {
            margin-top: 15px;
        }
        .reward-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        .reward-rows {
            margin-bottom: 20px;
        }
        .reward-row input[type="text"],
        .reward-row input[type="number"] {
            width: auto;
            min-width: 120px;
            margin-right: 8px;
            margin-bottom: 0;
        }
        .reward-row input[type="number"] {
            max-width: 80px;
        }
        .reward-row input[type="text"] {
            flex: 2;
        }
        .reward-row input, .reward-row select {
            height: 44px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #fafbfc;
            padding: 10px 14px;
        }
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-reward-btn {
            display: block;
            background: #fff;
            color: #28a745;
            border: 1.5px solid #28a745;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
            font-weight: 500;
            text-align: center;
            transition: background 0.2s, color 0.2s, border 0.2s;
            width: 100%;
        }
        .add-reward-btn:hover {
            background: #eafbe7;
        }
        .remove-member-btn {
            display: block;
            background: #fff;
            color: #dc3545;
            border: 1.5px solid #dc3545;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
            font-weight: 500;
            text-align: center;
            transition: background 0.2s, color 0.2s, border 0.2s;
            width: 100%;
        }
        .remove-member-btn:hover {
            background: #fbeaea;
        }
        .distribution-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .total-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            margin-bottom: 20px;
        }
        .distribution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .distribution-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .total-rewards-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .total-rewards-header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        .total-rewards-header:hover {
            background: linear-gradient(45deg, #218838, #1ea67a);
        }
        .total-rewards-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        .total-rewards-content {
            padding: 20px;
            background: white;
        }
        .total-rewards-content.collapsed {
            display: none;
        }
        .total-summary {
            text-align: center;
            margin-bottom: 20px;
        }
        .total-value-display {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
        }
        .total-distribution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .total-distribution-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        .total-transfers {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .boss-breakdown {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }
        .boss-breakdown-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            .room-controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            .room-controls > * {
                width: 100%;
                min-width: 0;
            }
            .member-info {
                grid-template-columns: 1fr;
            }
            .reward-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            .remove-btn {
                align-self: flex-end;
                margin-top: 6px;
                margin-left: 0;
                width: 44px;
                height: 44px;
                display: block;
            }
            .total-distribution-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 1200px) {
            .boss-row {
                gap: 0 16px;
            }
            .boss-row .boss-name, .boss-row .boss-name-empty {
                font-size: 1em;
                padding: 12px 12px;
            }
        }
        @media (max-width: 900px) {
            .boss-row {
                grid-template-columns: 90px repeat(2, 1fr) !important;
            }
            .room-controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            .room-controls > * {
                width: 100%;
                min-width: 0;
                height: auto;
            }
        }
        @media (max-width: 600px) {
            .boss-row {
                grid-template-columns: 60px 1fr !important;
                gap: 0 8px;
            }
            .boss-row .boss-name, .boss-row .boss-name-empty {
                font-size: 0.98em;
                padding: 10px 6px;
                min-width: 0;
                width: 100%;
                max-width: 100%;
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                text-align: center;
                word-break: break-word;
                line-height: 1.3;
            }
        }
        .party-section .btn-primary {
            margin-bottom: 24px;
        }
        .trade-fee-label {
            display: flex;
            align-items: center;
            font-size: 0.98em;
            font-weight: 500;
            color: #555;
            margin: 0 8px 0 0;
            gap: 4px;
            white-space: nowrap;
        }
        .trade-fee-checkbox {
            accent-color: #007aff;
            width: 18px;
            height: 18px;
            margin-right: 6px;
        }
        @media (max-width: 768px) {
            .trade-fee-label {
                margin-top: 6px;
                margin-bottom: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span id="statusText">Connecting...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>🍁 MapleStory Boss Rewards Split</h1>
            <p>Rewards Calculator</p>
        </div>

        <div class="room-section">
            <div id="createRoom" class="room-controls">
                <div class="input-group">
                    <label for="roomName">Room Name:</label>
                    <input type="text" id="roomName" placeholder="Enter room name">
                </div>
                <button class="btn btn-primary" onclick="createRoom()">Create Room</button>
            </div>

            <div id="joinRoom" class="room-controls hidden">
                <div class="input-group">
                    <label for="joinCode">Room Code:</label>
                    <input type="text" id="joinCode" placeholder="Enter room code">
                </div>
                <button class="btn btn-success" onclick="joinRoom()">Join Room</button>
            </div>

            <div id="roomInfo" class="room-info hidden">
                <h3>Room: <span id="currentRoomName"></span></h3>
                <p>Share this code: <strong id="currentRoomCode"></strong></p>
                <p>Direct link: <a href="#" id="roomLink">Copy Link</a></p>
            </div>
        </div>

        <div class="main-content">
            <div id="mainApp" class="hidden">
                <div class="boss-selection">
                    <h2>Select Weekly Bosses</h2>
                    <div class="boss-grid"></div>
                </div>

                <!-- Total Rewards Panel -->
                <div id="totalRewardsPanel" class="total-rewards-panel hidden">
                    <div class="total-rewards-header" onclick="toggleTotalPanel()">
                        <h3>📊 Total Rewards Summary</h3>
                        <span id="totalPanelToggle">▼</span>
                    </div>
                    <div id="totalRewardsContent" class="total-rewards-content">
                        <div class="total-summary">
                            <div class="total-value-display" id="grandTotalValue">Grand Total: 0 NESO</div>
                        </div>
                        <div class="total-distribution-grid" id="totalDistributionGrid"></div>
                        <div class="total-transfers" id="totalTransfers"></div>
                    </div>
                </div>

                <div id="bossDetails" class="boss-details">
                    <!-- Boss details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        let currentRoom = null;
                let selectedBosses = [];
                let partyMembers = [];
                let bossData = {};
                let socket = null;
                let saveTimeouts = {}; // For debouncing saves
                let dataLoadingComplete = false; // Track if initial data loading is complete
                let suppressSocketUpdates = false; // Prevent socket update loops
                let lastUpdateTimestamps = {}; // Track when we last updated each boss to prevent loops
        
                // Debounced save function to prevent focus loss
                function debouncedSave(bossId, delay = 1000) {
                    // Clear existing timeout for this boss
                    if (saveTimeouts[bossId]) {
                        clearTimeout(saveTimeouts[bossId]);
                    }
                    
                    // Set new timeout
                    saveTimeouts[bossId] = setTimeout(() => {
                        saveBossData(bossId);
                    }, delay);
                }
        
                // Initialize Socket.IO connection
                function initializeSocket() {
                    socket = io();
                    
                    socket.on('connect', () => {
                        updateConnectionStatus('connected');
                        if (currentRoom) {
                            socket.emit('joinRoom', currentRoom.code);
                        }
                    });
                    
                    socket.on('disconnect', () => {
                        updateConnectionStatus('disconnected');
                    });
                    
                    socket.on('bossDataUpdated', (data) => {
                        console.log(`📡 Received boss update for: ${data.bossId}`);
                        
                        // Skip if we're suppressing updates during initial load
                        if (suppressSocketUpdates) {
                            console.log(`🚫 Suppressing update for ${data.bossId} during initial load`);
                            return;
                        }
        
                        // Skip if this update is too recent (within 500ms of our last save)
                        const lastUpdate = lastUpdateTimestamps[data.bossId] || 0;
                        const timeSinceLastUpdate = Date.now() - lastUpdate;
                        if (timeSinceLastUpdate < 500) {
                            console.log(`⏰ Skipping update for ${data.bossId} - too recent (${timeSinceLastUpdate}ms)`);
                            return;
                        }
        
                        // Check if the data is actually different
                        const currentData = bossData[data.bossId]?.data;
                        const newData = data.data;
                        
                        if (JSON.stringify(currentData) === JSON.stringify(newData)) {
                            console.log(`🔄 Data unchanged for ${data.bossId}, skipping update`);
                            return;
                        }
        
                        console.log(`✅ Applying real-time update for ${data.bossId}`);
                        
                        // Update our local data
                        bossData[data.bossId] = {
                            name: data.bossName,
                            data: data.data,
                            active: true
                        };
                        
                        // If this boss is currently selected, update the UI
                        if (selectedBosses.includes(data.bossId)) {
                            // Remember focused element to restore focus after update
                            const activeElement = document.activeElement;
                            const activeElementId = activeElement?.id;
                            const cursorPosition = activeElement?.selectionStart;
                            
                            // Apply the update
                            restoreBossData(data.bossId);
                            updateDistribution(data.bossId);
                            updateTotalRewardsPanel();
                            
                            // Restore focus and cursor position
                            setTimeout(() => {
                                if (activeElementId) {
                                    const elementToFocus = document.getElementById(activeElementId);
                                    if (elementToFocus) {
                                        elementToFocus.focus();
                                        if (typeof cursorPosition === 'number' && elementToFocus.setSelectionRange) {
                                            elementToFocus.setSelectionRange(cursorPosition, cursorPosition);
                                        }
                                    }
                                }
                            }, 50);
                        }
                    });
        
                    // Handle save errors
                    socket.on('saveError', (error) => {
                        console.error('Save error:', error);
                        showNotification('Failed to save data: ' + error.message, 'error');
                    });
                }
        
                function updateConnectionStatus(status) {
                    const statusElement = document.getElementById('connectionStatus');
                    const statusText = document.getElementById('statusText');
                    
                    if (status === 'connected') {
                        statusElement.className = 'connection-status status-connected';
                        statusText.textContent = '● Connected';
                    } else {
                        statusElement.className = 'connection-status status-disconnected';
                        statusText.textContent = '● Disconnected';
                    }
                }
        
                // Show notification to user
                function showNotification(message, type = 'info') {
                    // Create notification element
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 70px;
                        right: 20px;
                        padding: 12px 20px;
                        border-radius: 8px;
                        color: white;
                        font-weight: bold;
                        z-index: 1001;
                        max-width: 300px;
                        word-wrap: break-word;
                        ${type === 'error' ? 'background: #dc3545;' : 'background: #28a745;'}
                    `;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 3000);
                }

// Room management
async function createRoom() {
            const roomName = document.getElementById('roomName').value.trim();
            if (!roomName) {
                alert('Please enter a room name');
                return;
            }

            try {
                const response = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: roomName })
                });

                if (response.ok) {
                    currentRoom = await response.json();
                    onRoomJoinedOrCreated();
                    socket.emit('joinRoom', currentRoom.code);
                    dataLoadingComplete = true; // New room, no data to load
                } else {
                    alert('Failed to create room');
                }
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Failed to create room');
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!roomCode) {
                alert('Please enter a room code');
                return;
            }

            try {
                const response = await fetch(`/api/rooms/${roomCode}`);
                
                if (response.ok) {
                    currentRoom = await response.json();
                    onRoomJoinedOrCreated();
                    socket.emit('joinRoom', currentRoom.code);
                    await loadBossData();
                } else {
                    alert('Room not found');
                }
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Failed to join room');
            }
        }

        async function loadBossData() {
            console.log(`🚀 STARTING loadBossData for room: ${currentRoom.code}`);
            try {
                const url = `/api/rooms/${currentRoom.code}/boss-data`;
                console.log(`📡 Fetching from: ${url}`);
                const response = await fetch(url);
                console.log(`📋 Response status: ${response.status}`);
                if (response.ok) {
                    const serverBossData = await response.json();
                    console.log(`📦 SERVER RETURNED:`, serverBossData);
                    // Store the data
                    Object.keys(serverBossData).forEach(bossId => {
                        bossData[bossId] = {
                            name: serverBossData[bossId].name,
                            data: serverBossData[bossId].data,
                            active: true
                        };
                    });
                    // Automatically select all bosses with data
                    selectedBosses = Object.keys(serverBossData);
                    renderBossGrid();
                    updateBossDetails();
                    // Restore data after UI is ready
                    setTimeout(() => {
                        Object.keys(serverBossData).forEach(bossId => {
                            console.log(`🔄 Restoring ${bossId}...`);
                            restoreBossData(bossId);
                        });
                        dataLoadingComplete = true;
                    }, 500);
                } else {
                    console.error(`❌ Server error: ${response.status}`);
                }
            } catch (error) {
                console.error(`💥 Load error:`, error);
            }
        }

        function showRoom() {
            document.getElementById('createRoom').classList.add('hidden');
            document.getElementById('joinRoom').classList.add('hidden');
            document.getElementById('roomInfo').classList.remove('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            document.getElementById('currentRoomName').textContent = currentRoom.name;
            document.getElementById('currentRoomCode').textContent = currentRoom.code;
            
            const roomLink = document.getElementById('roomLink');
            const url = `${window.location.origin}?room=${currentRoom.code}`;
            roomLink.href = url;
            roomLink.onclick = (e) => {
                e.preventDefault(); // Prevent navigation
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied to clipboard!');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Link copied to clipboard!');
                });
            };
        }

        // Boss selection
        function toggleBoss(bossId) {
            const idx = selectedBosses.indexOf(bossId);
            if (idx === -1) {
                selectedBosses.push(bossId);
            } else {
                selectedBosses.splice(idx, 1);
            }
            renderBossGrid();
            updateBossDetails();
        }

        function updateBossDetails() {
            const bossDetails = document.getElementById('bossDetails');
            
            if (selectedBosses.length === 0) {
                bossDetails.classList.remove('active');
                bossDetails.innerHTML = '';
                updateTotalRewardsPanel();
                return;
            }

            bossDetails.classList.add('active');
            
            selectedBosses.forEach(bossId => {
                const existingSection = document.getElementById(`boss-section-${bossId}`);
                if (!existingSection) {
                    const bossName = document.getElementById(bossId)?.textContent || bossId;
                    const bossSection = createBossSection(bossId, bossName);
                    bossDetails.appendChild(bossSection);
                    if (!bossData[bossId]) {
                        bossData[bossId] = {
                            name: bossName,
                            data: { members: [] },
                            active: true
                        };
                    }
                }
            });
            
            const allSections = bossDetails.querySelectorAll('.boss-section');
            allSections.forEach(section => {
                const sectionBossId = section.id.replace('boss-section-', '');
                if (!selectedBosses.includes(sectionBossId)) {
                    section.remove();
                    if (bossData[sectionBossId]) {
                        bossData[sectionBossId].active = false;
                    }
                }
            });

            updateTotalRewardsPanel();
        }

        function createBossSection(bossId, bossName) {
            const section = document.createElement('div');
            section.className = 'boss-section';
            section.id = `boss-section-${bossId}`;
            section.innerHTML = `
                <div class="boss-header" onclick="toggleBossPanel('${bossId}')">
                    <div>
                        <h3>${bossName}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.9;">Date: ${new Date().toLocaleDateString()}</p>
                    </div>
                    <span class="boss-toggle" id="toggle-${bossId}">▼</span>
                </div>
                <div class="boss-content expanded" id="content-${bossId}">
                    <div class="party-section">
                        <h4>Party Members</h4>
                        <button class="btn btn-primary" onclick="addPartyMember('${bossId}')">Add Party Member</button>
                        <div id="party-${bossId}" class="party-members"></div>
                    </div>
                    <div class="distribution-section">
                        <div class="total-value" id="total-${bossId}">Total Value: 0 NESO</div>
                        <div class="distribution-grid" id="distribution-${bossId}"></div>
                    </div>
                </div>
            `;
            
            // If we have data for this boss, schedule restoration after DOM is ready
            if (bossData[bossId] && bossData[bossId].data && bossData[bossId].data.members) {
                setTimeout(() => {
                    console.log(`Scheduling restore for ${bossId}`);
                    restoreBossData(bossId);
                }, 50);
            }
            
            return section;
        }

        function toggleBossPanel(bossId) {
            const content = document.getElementById(`content-${bossId}`);
            const toggle = document.getElementById(`toggle-${bossId}`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                toggle.textContent = '▼';
            } else {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                toggle.textContent = '▶';
            }
        }

        function addPartyMember(bossId) {
            const partyContainer = document.getElementById(`party-${bossId}`);
            const memberId = `member-${bossId}-${Date.now()}`;
            
            const memberDiv = document.createElement('div');
            memberDiv.className = 'party-member';
            memberDiv.id = memberId;
            memberDiv.innerHTML = `
                <div class="member-info">
                    <div class="input-group">
                        <label>Character Name:</label>
                        <input type="text" placeholder="Enter character name" 
                               oninput="debouncedSave('${bossId}'); updateDistributionOnly('${bossId}')"
                               onchange="showNotification('New member added', 'info')">
                    </div>
                    <div class="input-group">
                        <label>Wallet Address:</label>
                        <input type="text" placeholder="0x..." 
                               oninput="debouncedSave('${bossId}'); updateDistributionOnly('${bossId}')">
                    </div>
                    <div class="input-group">
                        <label>Share %:</label>
                        <input type="number" value="0" min="0" max="100" 
                               oninput="debouncedSave('${bossId}'); updateDistributionOnly('${bossId}')">
                    </div>
                </div>
                <div class="reward-input">
                    <h5>Rewards:</h5>
                    <div class="reward-rows" id="rewards-${memberId}"></div>
                    <button class="add-reward-btn" onclick="addReward('${memberId}')">+ Add Reward</button>
                </div>
                <button class="remove-member-btn" onclick="removeMember('${memberId}', '${bossId}')" style="margin-top: 12px;">× Remove Member</button>
            `;
            
            partyContainer.appendChild(memberDiv);
            updateEvenDistribution(bossId);
            debouncedSave(bossId, 200); // Quick save for new member
        }

        function addReward(memberId) {
            const rewardsContainer = document.getElementById(`rewards-${memberId}`);
            const rewardId = `reward-${Date.now()}`;
            const bossId = memberId.split('-').slice(1, -1).join('-');
            
            const rewardDiv = document.createElement('div');
            rewardDiv.className = 'reward-row';
            rewardDiv.id = rewardId;
            rewardDiv.innerHTML = `
                <input type="text" placeholder="Reward Name" 
                       oninput="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')"
                       onchange="showNotification('New reward added', 'info')">
                <input type="number" placeholder="1" min="1" value="1" 
                       oninput="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')">
                <input type="number" placeholder="NESO" min="0" 
                       oninput="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')">
                <label class="trade-fee-label"><input type="checkbox" class="trade-fee-checkbox" onchange="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')"> Apply 5% Trade Fee</label>
                <button class="remove-btn" onclick="removeReward('${rewardId}', '${memberId}')">×</button>
            `;
            
            rewardsContainer.appendChild(rewardDiv);
            calculateRewardsOnly(memberId);
            debouncedSave(bossId, 200);
        }

        function removeReward(rewardId, memberId) {
            const bossId = memberId.split('-').slice(1, -1).join('-');
            document.getElementById(rewardId).remove();
            calculateRewardsOnly(memberId);
            showNotification('Reward removed', 'info');
            debouncedSave(bossId, 200);
        }

        function removeMember(memberId, bossId) {
            const memberDiv = document.getElementById(memberId);
            const characterName = memberDiv.querySelector('input[type="text"]').value || 'member';
            document.getElementById(memberId).remove();
            updateEvenDistribution(bossId);
            showNotification(`${characterName} removed from party`, 'info');
            debouncedSave(bossId, 200);
        }

        function calculateRewardsOnly(memberId) {
            const bossId = memberId.split('-').slice(1, -1).join('-');
            updateDistributionOnly(bossId);
        }

        function updateEvenDistribution(bossId) {
            const partyContainer = document.getElementById(`party-${bossId}`);
            const members = partyContainer.querySelectorAll('.party-member');
            
            if (members.length === 0) return;
            
            const evenShare = Math.floor(100 / members.length);
            const remainder = 100 % members.length;
            
            members.forEach((member, index) => {
                const shareInput = member.querySelector('input[type="number"]');
                shareInput.value = evenShare + (index < remainder ? 1 : 0);
            });
            
            updateDistributionOnly(bossId);
        }

        // New function that only updates distribution without triggering re-renders
        function updateDistributionOnly(bossId) {
            const partyContainer = document.getElementById(`party-${bossId}`);
            const members = partyContainer.querySelectorAll('.party-member');
            
            let totalValue = 0;
            let totalPercentage = 0;
            const memberData = [];

            members.forEach(member => {
                const characterName = member.querySelector('input[type="text"]').value;
                const walletAddress = member.querySelectorAll('input[type="text"]')[1].value;
                const sharePercentage = parseInt(member.querySelector('input[type="number"]').value) || 0;
                
                const rewardRows = member.querySelectorAll('.reward-row');
                let memberRewardValue = 0;
                
                rewardRows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const quantity = parseInt(inputs[1].value) || 0;
                    const nesoPerItem = parseInt(inputs[2].value) || 0;
                    const tradeFeeChecked = row.querySelector('.trade-fee-checkbox')?.checked;
                    let rewardValue = quantity * nesoPerItem;
                    if (tradeFeeChecked) rewardValue = Math.floor(rewardValue * 0.95);
                    memberRewardValue += rewardValue;
                });
                
                totalValue += memberRewardValue;
                totalPercentage += sharePercentage;
                
                memberData.push({
                    name: characterName,
                    wallet: walletAddress,
                    percentage: sharePercentage,
                    earnedValue: memberRewardValue
                });
            });

            document.getElementById(`total-${bossId}`).textContent = `Total Value: ${totalValue} NESO (${nesoToNxpc(totalValue)} NXPC)`;
            
            const distributionContainer = document.getElementById(`distribution-${bossId}`);
            distributionContainer.innerHTML = '';
            
            const transfers = calculateTransfers(memberData, totalValue);
            
            memberData.forEach((member, index) => {
                const distributionAmount = Math.floor((totalValue * member.percentage) / 100);
                const deficit = distributionAmount - member.earnedValue;
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'distribution-item';
                memberDiv.innerHTML = `
                    <h5>${member.name || 'Unnamed'}</h5>
                    <p>Share: ${member.percentage}%</p>
                    <p>Should Receive: <strong>${distributionAmount} NESO</strong></p>
                    <p>Earned: ${member.earnedValue} NESO</p>
                    <p style="color: ${deficit > 0 ? 'green' : deficit < 0 ? 'red' : 'black'};">
                        ${deficit > 0 ? `Needs: +${deficit} NESO` : deficit < 0 ? `Owes: ${Math.abs(deficit)} NESO` : 'Balanced'}
                    </p>
                    <p style="font-size: 0.8em; word-break: break-all;">${member.wallet || 'No wallet'}</p>
                `;
                distributionContainer.appendChild(memberDiv);
            });

            if (transfers.length > 0) {
                const transferDiv = document.createElement('div');
                transferDiv.style.cssText = 'background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; grid-column: 1 / -1;';
                transferDiv.innerHTML = `
                    <h4>💸 Transfer Instructions:</h4>
                    ${transfers.map(transfer => 
                        `<p><strong>${transfer.from}</strong> → <strong>${transfer.to}</strong>: ${transfer.amount} NESO (${nesoToNxpc(transfer.amount)} NXPC)</p>`
                    ).join('')}
                `;
                distributionContainer.appendChild(transferDiv);
            }

            if (totalPercentage !== 100 && members.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; grid-column: 1 / -1;';
                warningDiv.textContent = `Warning: Total percentage is ${totalPercentage}%, should be 100%`;
                distributionContainer.insertBefore(warningDiv, distributionContainer.firstChild);
            }

            updateTotalRewardsPanel();
        }

        function calculateTransfers(memberData, totalValue) {
            const transfers = [];
            const creditors = [];
            const debtors = [];

            memberData.forEach(member => {
                const shouldReceive = Math.floor((totalValue * member.percentage) / 100);
                const deficit = shouldReceive - member.earnedValue;
                
                if (deficit > 0) {
                    creditors.push({ name: member.name, amount: deficit });
                } else if (deficit < 0) {
                    debtors.push({ name: member.name, amount: Math.abs(deficit) });
                }
            });

            let creditorIndex = 0;
            let debtorIndex = 0;

            while (creditorIndex < creditors.length && debtorIndex < debtors.length) {
                const creditor = creditors[creditorIndex];
                const debtor = debtors[debtorIndex];
                
                const transferAmount = Math.min(creditor.amount, debtor.amount);
                
                if (transferAmount > 0) {
                    transfers.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: transferAmount
                    });
                }
                
                creditor.amount -= transferAmount;
                debtor.amount -= transferAmount;
                
                if (creditor.amount === 0) creditorIndex++;
                if (debtor.amount === 0) debtorIndex++;
            }

            return transfers;
        }

  // Data persistence and real-time sync
  async function saveBossData(bossId, suppressBroadcast = false) {
            const partyContainer = document.getElementById(`party-${bossId}`);
            if (!partyContainer || !currentRoom) return;
            
            const members = partyContainer.querySelectorAll('.party-member');
            const memberData = [];

            members.forEach(member => {
                const inputs = member.querySelectorAll('input');
                const characterName = inputs[0].value;
                const walletAddress = inputs[1].value;
                const sharePercentage = inputs[2].value;
                
                const rewardRows = member.querySelectorAll('.reward-row');
                const rewards = [];
                
                rewardRows.forEach(row => {
                    const rewardInputs = row.querySelectorAll('input');
                    rewards.push({
                        itemName: rewardInputs[0].value,
                        quantity: rewardInputs[1].value,
                        nesoPerItem: rewardInputs[2].value,
                        tradeFee: row.querySelector('.trade-fee-checkbox')?.checked || false
                    });
                });
                
                memberData.push({
                    id: member.id,
                    characterName,
                    walletAddress,
                    sharePercentage,
                    rewards
                });
            });

            const bossName = document.getElementById(bossId).textContent;
            
            if (!bossData[bossId]) {
                bossData[bossId] = {};
            }
            bossData[bossId].data = { members: memberData };
            bossData[bossId].active = true;

            // Record timestamp of this update
            lastUpdateTimestamps[bossId] = Date.now();

            // Only send to server if not suppressing broadcast
            if (!suppressBroadcast && socket && socket.connected) {
                socket.emit('updateBossData', {
                    roomCode: currentRoom.code,
                    bossId,
                    bossName,
                    bossData: { members: memberData }
                });
            }
        }

        function restoreBossData(bossId) {
            if (!bossData[bossId] || !bossData[bossId].data || !bossData[bossId].data.members) {
                return;
            }
            
            const partyContainer = document.getElementById(`party-${bossId}`);
            if (!partyContainer) {
                setTimeout(() => restoreBossData(bossId), 100);
                return;
            }

            // Clear existing members first
            partyContainer.innerHTML = '';

            bossData[bossId].data.members.forEach((memberData, memberIndex) => {
                const memberId = memberData.id || `member-${bossId}-${Date.now()}-${memberIndex}`;
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'party-member';
                memberDiv.id = memberId;
                memberDiv.innerHTML = `
                    <div class="member-info">
                        <div class="input-group">
                            <label>Character Name:</label>
                            <input type="text" placeholder="Enter character name" value="${memberData.characterName || ''}" 
                                   oninput="debouncedSave('${bossId}'); updateDistributionOnly('${bossId}')"
                                   onchange="showNotification('Character name updated', 'info')">
                        </div>
                        <div class="input-group">
                            <label>Wallet Address:</label>
                            <input type="text" placeholder="0x..." value="${memberData.walletAddress || ''}" 
                                   oninput="debouncedSave('${bossId}'); updateDistributionOnly('${bossId}')"
                                   onchange="showNotification('Wallet address updated', 'info')">
                        </div>
                        <div class="input-group">
                            <label>Share %:</label>
                            <input type="number" value="${memberData.sharePercentage || 0}" min="0" max="100" 
                                   oninput="debouncedSave('${bossId}'); updateDistributionOnly('${bossId}')"
                                   onchange="showNotification('Share percentage updated', 'info')">
                        </div>
                    </div>
                    <div class="reward-input">
                        <h5>Rewards:</h5>
                        <div class="reward-rows" id="rewards-${memberId}"></div>
                        <button class="add-reward-btn" onclick="addReward('${memberId}')">+ Add Reward</button>
                    </div>
                    <button class="remove-member-btn" onclick="removeMember('${memberId}', '${bossId}')" style="margin-top: 12px;">× Remove Member</button>
                `;
                
                partyContainer.appendChild(memberDiv);
                
                // Restore rewards for this member
                if (memberData.rewards && memberData.rewards.length > 0) {
                    const rewardsContainer = document.getElementById(`rewards-${memberId}`);
                    memberData.rewards.forEach((reward, rewardIndex) => {
                        const rewardId = `reward-${Date.now()}-${memberIndex}-${rewardIndex}`;
                        const rewardDiv = document.createElement('div');
                        rewardDiv.className = 'reward-row';
                        rewardDiv.id = rewardId;
                        rewardDiv.innerHTML = `
                            <input type="text" placeholder="Reward Name" value="${reward.itemName || ''}" 
                                   oninput="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')"
                                   onchange="showNotification('Reward updated', 'info')">
                            <input type="number" placeholder="1" min="1" value="${reward.quantity || 1}" 
                                   oninput="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')"
                                   onchange="showNotification('Quantity updated', 'info')">
                            <input type="number" placeholder="NESO" min="0" value="${reward.nesoPerItem || 0}" 
                                   oninput="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')"
                                   onchange="showNotification('NESO amount updated', 'info')">
                            <label class="trade-fee-label"><input type="checkbox" class="trade-fee-checkbox" ${reward.tradeFee ? 'checked' : ''} onchange="debouncedSave('${bossId}'); calculateRewardsOnly('${memberId}')"> Apply 5% Trade Fee</label>
                            <button class="remove-btn" onclick="removeReward('${rewardId}', '${memberId}')">×</button>
                        `;
                        rewardsContainer.appendChild(rewardDiv);
                    });
                }
            });
            
            // Update the distribution after restoring all data
            setTimeout(() => {
                updateDistribution(bossId);
            }, 10);
        }

        // Distribution calculation
        function updateDistribution(bossId) {
            const partyContainer = document.getElementById(`party-${bossId}`);
            const members = partyContainer.querySelectorAll('.party-member');
            
            let totalValue = 0;
            let totalPercentage = 0;
            const memberData = [];

            members.forEach(member => {
                const characterName = member.querySelector('input[type="text"]').value;
                const walletAddress = member.querySelectorAll('input[type="text"]')[1].value;
                const sharePercentage = parseInt(member.querySelector('input[type="number"]').value) || 0;
                
                const rewardRows = member.querySelectorAll('.reward-row');
                let memberRewardValue = 0;
                
                rewardRows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const quantity = parseInt(inputs[1].value) || 0;
                    const nesoPerItem = parseInt(inputs[2].value) || 0;
                    const tradeFeeChecked = row.querySelector('.trade-fee-checkbox')?.checked;
                    let rewardValue = quantity * nesoPerItem;
                    if (tradeFeeChecked) rewardValue = Math.floor(rewardValue * 0.95);
                    memberRewardValue += rewardValue;
                });
                
                totalValue += memberRewardValue;
                totalPercentage += sharePercentage;
                
                memberData.push({
                    name: characterName,
                    wallet: walletAddress,
                    percentage: sharePercentage,
                    earnedValue: memberRewardValue
                });
            });

            document.getElementById(`total-${bossId}`).textContent = `Total Value: ${totalValue} NESO (${nesoToNxpc(totalValue)} NXPC)`;
            
            const distributionContainer = document.getElementById(`distribution-${bossId}`);
            distributionContainer.innerHTML = '';
            
            const transfers = calculateTransfers(memberData, totalValue);
            
            memberData.forEach((member, index) => {
                const distributionAmount = Math.floor((totalValue * member.percentage) / 100);
                const deficit = distributionAmount - member.earnedValue;
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'distribution-item';
                memberDiv.innerHTML = `
                    <h5>${member.name || 'Unnamed'}</h5>
                    <p>Share: ${member.percentage}%</p>
                    <p>Should Receive: <strong>${distributionAmount} NESO</strong></p>
                    <p>Earned: ${member.earnedValue} NESO</p>
                    <p style="color: ${deficit > 0 ? 'green' : deficit < 0 ? 'red' : 'black'};">
                        ${deficit > 0 ? `Needs: +${deficit} NESO` : deficit < 0 ? `Owes: ${Math.abs(deficit)} NESO` : 'Balanced'}
                    </p>
                    <p style="font-size: 0.8em; word-break: break-all;">${member.wallet || 'No wallet'}</p>
                `;
                distributionContainer.appendChild(memberDiv);
            });

            if (transfers.length > 0) {
                const transferDiv = document.createElement('div');
                transferDiv.style.cssText = 'background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; grid-column: 1 / -1;';
                transferDiv.innerHTML = `
                    <h4>💸 Transfer Instructions:</h4>
                    ${transfers.map(transfer => 
                        `<p><strong>${transfer.from}</strong> → <strong>${transfer.to}</strong>: ${transfer.amount} NESO (${nesoToNxpc(transfer.amount)} NXPC)</p>`
                    ).join('')}
                `;
                distributionContainer.appendChild(transferDiv);
            }

            if (totalPercentage !== 100 && members.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; grid-column: 1 / -1;';
                warningDiv.textContent = `Warning: Total percentage is ${totalPercentage}%, should be 100%`;
                distributionContainer.insertBefore(warningDiv, distributionContainer.firstChild);
            }

            updateTotalRewardsPanel();
        }

        // Total rewards panel functions
        function updateTotalRewardsPanel() {
            const totalPanel = document.getElementById('totalRewardsPanel');
            
            if (selectedBosses.length < 2) {
                totalPanel.classList.add('hidden');
                return;
            }

            totalPanel.classList.remove('hidden');
            calculateTotalRewards();
        }

        function toggleTotalPanel() {
            const content = document.getElementById('totalRewardsContent');
            const toggle = document.getElementById('totalPanelToggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '▶';
            }
        }

        function calculateTotalRewards() {
            const allMembers = new Map();
            let grandTotal = 0;

            selectedBosses.forEach(bossId => {
                const partyContainer = document.getElementById(`party-${bossId}`);
                if (!partyContainer) return;

                const members = partyContainer.querySelectorAll('.party-member');
                let bossTotal = 0;

                members.forEach(member => {
                    const characterName = member.querySelector('input[type="text"]').value.trim();
                    const walletAddress = member.querySelectorAll('input[type="text"]')[1].value.trim();
                    const sharePercentage = parseInt(member.querySelector('input[type="number"]').value) || 0;
                    
                    const rewardRows = member.querySelectorAll('.reward-row');
                    let memberEarnedValue = 0;
                    
                    rewardRows.forEach(row => {
                        const inputs = row.querySelectorAll('input');
                        const quantity = parseInt(inputs[1].value) || 0;
                        const nesoPerItem = parseInt(inputs[2].value) || 0;
                        const tradeFeeChecked = row.querySelector('.trade-fee-checkbox')?.checked;
                        let rewardValue = quantity * nesoPerItem;
                        if (tradeFeeChecked) rewardValue = Math.floor(rewardValue * 0.95);
                        memberEarnedValue += rewardValue;
                    });

                    bossTotal += memberEarnedValue;

                    if (characterName) {
                        const memberKey = characterName.toLowerCase();
                        
                        if (!allMembers.has(memberKey)) {
                            allMembers.set(memberKey, {
                                displayName: characterName,
                                wallet: walletAddress,
                                bosses: new Map(),
                                totalEarned: 0,
                                totalShouldReceive: 0
                            });
                        }

                        const memberData = allMembers.get(memberKey);
                        
                        if (!memberData.wallet && walletAddress) {
                            memberData.wallet = walletAddress;
                        }

                        const shouldReceive = Math.floor((bossTotal * sharePercentage) / 100);
                        memberData.bosses.set(bossId, {
                            earned: memberEarnedValue,
                            shouldReceive: shouldReceive,
                            percentage: sharePercentage,
                            bossTotal: bossTotal
                        });
                    }
                });

                grandTotal += bossTotal;
            });

            allMembers.forEach((memberData, memberKey) => {
                memberData.totalEarned = 0;
                memberData.totalShouldReceive = 0;

                memberData.bosses.forEach((bossData, bossId) => {
                    const partyContainer = document.getElementById(`party-${bossId}`);
                    if (!partyContainer) return;

                    const members = partyContainer.querySelectorAll('.party-member');
                    let bossTotal = 0;

                    members.forEach(member => {
                        const rewardRows = member.querySelectorAll('.reward-row');
                        rewardRows.forEach(row => {
                            const inputs = row.querySelectorAll('input');
                            const quantity = parseInt(inputs[1].value) || 0;
                            const nesoPerItem = parseInt(inputs[2].value) || 0;
                            const tradeFeeChecked = row.querySelector('.trade-fee-checkbox')?.checked;
                            let rewardValue = quantity * nesoPerItem;
                            if (tradeFeeChecked) rewardValue = Math.floor(rewardValue * 0.95);
                            bossTotal += rewardValue;
                        });
                    });

                    const shouldReceive = Math.floor((bossTotal * bossData.percentage) / 100);
                    bossData.shouldReceive = shouldReceive;
                    bossData.bossTotal = bossTotal;

                    memberData.totalEarned += bossData.earned;
                    memberData.totalShouldReceive += shouldReceive;
                });
            });

            displayTotalRewards(allMembers, grandTotal);
        }

        function displayTotalRewards(allMembers, grandTotal) {
            document.getElementById('grandTotalValue').textContent = `Grand Total: ${grandTotal} NESO (${nesoToNxpc(grandTotal)} NXPC)`;

            const distributionGrid = document.getElementById('totalDistributionGrid');
            distributionGrid.innerHTML = '';

            const transferData = [];

            allMembers.forEach((memberData, memberKey) => {
                const deficit = memberData.totalShouldReceive - memberData.totalEarned;
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'total-distribution-item';
                
                let bossBreakdown = '';
                memberData.bosses.forEach((bossData, bossId) => {
                    const bossName = document.getElementById(bossId)?.textContent || bossId;
                    bossBreakdown += `
                        <div class="boss-breakdown-item">
                            <span>${bossName}:</span>
                            <span>Earned ${bossData.earned}, Should get ${bossData.shouldReceive} (${bossData.percentage}%)</span>
                        </div>
                    `;
                });

                memberDiv.innerHTML = `
                    <h5>${memberData.displayName}</h5>
                    <p><strong>Total Earned:</strong> ${memberData.totalEarned} NESO (${nesoToNxpc(memberData.totalEarned)} NXPC)</p>
                    <p><strong>Total Should Receive:</strong> ${memberData.totalShouldReceive} NESO (${nesoToNxpc(memberData.totalShouldReceive)} NXPC)</p>
                    <p style="color: ${deficit > 0 ? 'green' : deficit < 0 ? 'red' : 'black'}; font-weight: bold;">
                        ${deficit > 0 ? `Needs: +${deficit} NESO` : deficit < 0 ? `Owes: ${Math.abs(deficit)} NESO` : 'Balanced ✓'}
                    </p>
                    <div class="boss-breakdown">
                        <strong>Boss Breakdown:</strong>
                        ${bossBreakdown}
                    </div>
                    <p style="font-size: 0.8em; word-break: break-all; color: #6c757d;">
                        ${memberData.wallet || 'No wallet address'}
                    </p>
                `;
                
                distributionGrid.appendChild(memberDiv);

                transferData.push({
                    name: memberData.displayName,
                    wallet: memberData.wallet,
                    deficit: deficit
                });
            });

            displayOptimizedTransfers(transferData);
        }

        function displayOptimizedTransfers(transferData) {
            const transfersContainer = document.getElementById('totalTransfers');
            
            const creditors = transferData.filter(member => member.deficit > 0);
            const debtors = transferData.filter(member => member.deficit < 0);

            if (creditors.length === 0 && debtors.length === 0) {
                transfersContainer.innerHTML = '<h4>💰 All members are balanced! No transfers needed.</h4>';
                return;
            }

            const transfers = [];
            let creditorIndex = 0;
            let debtorIndex = 0;

            const creditorsCopy = creditors.map(c => ({ ...c, amount: c.deficit }));
            const debtorsCopy = debtors.map(d => ({ ...d, amount: Math.abs(d.deficit) }));

            while (creditorIndex < creditorsCopy.length && debtorIndex < debtorsCopy.length) {
                const creditor = creditorsCopy[creditorIndex];
                const debtor = debtorsCopy[debtorIndex];
                
                const transferAmount = Math.min(creditor.amount, debtor.amount);
                
                if (transferAmount > 0) {
                    transfers.push({
                        from: debtor.name,
                        fromWallet: debtor.wallet,
                        to: creditor.name,
                        toWallet: creditor.wallet,
                        amount: transferAmount
                    });
                }
                
                creditor.amount -= transferAmount;
                debtor.amount -= transferAmount;
                
                if (creditor.amount === 0) creditorIndex++;
                if (debtor.amount === 0) debtorIndex++;
            }

            let transfersHTML = '<h4>💸 Optimized Transfer Instructions:</h4>';
            
            if (transfers.length === 0) {
                transfersHTML += '<p>No transfers needed - all members are balanced!</p>';
            } else {
                transfers.forEach(transfer => {
                    transfersHTML += `
                        <div style="background: white; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #28a745;">
                            <strong>${transfer.from}</strong> → <strong>${transfer.to}</strong>: <span style="color: #28a745; font-weight: bold;">${transfer.amount} NESO (${nesoToNxpc(transfer.amount)} NXPC)</span><br>
                            <small style="color: #6c757d;">
                                From: ${transfer.fromWallet || 'No wallet'}<br>
                                To: ${transfer.toWallet || 'No wallet'}
                            </small>
                        </div>
                    `;
                });
            }

            transfersContainer.innerHTML = transfersHTML;
        }

        // --- Render Boss Selection Grid (star box left, bosses in columns, aligned) ---
        function renderBossGrid() {
            const grid = document.querySelector('.boss-grid');
            grid.innerHTML = '';
            // Find the max number of bosses in any group for column count
            const maxBossesPerRow = Math.max(...bossGroups.map(g => g.bosses.length));
            bossGroups.forEach(group => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'boss-row';
                rowDiv.style.gridTemplateColumns = `110px repeat(${maxBossesPerRow}, 1fr)`;
                // Star box (once per row)
                const starBox = document.createElement('div');
                starBox.className = 'boss-starbox';
                for (let i = 0; i < group.stars; i++) {
                    const star = document.createElement('span');
                    star.className = 'boss-star';
                    star.innerHTML = '★';
                    starBox.appendChild(star);
                }
                rowDiv.appendChild(starBox);
                // Boss names for this row, fill with empty cells if needed
                for (let i = 0; i < maxBossesPerRow; i++) {
                    if (group.bosses[i]) {
                        const boss = group.bosses[i];
                        const isSelected = selectedBosses.includes(boss.id);
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'boss-name ' + (isSelected ? 'selected' : 'unselected');
                        nameSpan.textContent = boss.name;
                        nameSpan.id = boss.id;
                        nameSpan.onclick = () => toggleBoss(boss.id);
                        rowDiv.appendChild(nameSpan);
                    } else {
                        // Empty cell for alignment
                        const emptySpan = document.createElement('span');
                        emptySpan.className = 'boss-name-empty';
                        emptySpan.textContent = '';
                        rowDiv.appendChild(emptySpan);
                    }
                }
                grid.appendChild(rowDiv);
            });
        }

        // --- Boss List Data (grouped by star count) ---
        const bossGroups = [
            { stars: 5, bosses: [
                { id: 'chaos-papulatus', name: 'Papulatus (Chaos)' },
                { id: 'normal-lotus', name: 'Lotus (Normal)' },
                { id: 'normal-damien', name: 'Damien (Normal)' },
            ]},
            { stars: 4, bosses: [
                { id: 'chaos-vellum', name: 'Vellum (Chaos)' },
                { id: 'hard-magnus', name: 'Magnus (Hard)' },
            ]},
            { stars: 3, bosses: [
                { id: 'chaos-pierre', name: 'Pierre (Chaos)' },
                { id: 'chaos-von-bon', name: 'Von Bon (Chaos)' },
                { id: 'chaos-crimson-queen', name: 'Crimson Queen (Chaos)' },
            ]},
            { stars: 2, bosses: [
                { id: 'normal-cygnus', name: 'Cygnus (Normal)' },
                { id: 'chaos-zakum', name: 'Zakum (Chaos)' },
            ]},
            { stars: 1, bosses: [
                { id: 'easy-cygnus', name: 'Cygnus (Easy)' },
                { id: 'hard-hilla', name: 'Hilla (Hard)' },
                { id: 'chaos-pink-bean', name: 'Pink Bean (Chaos)' },
            ]},
        ];

        // --- After DOMContentLoaded or window.onload, call renderBossGrid() ---
        window.addEventListener('load', () => {
            initializeSocket();
            document.getElementById('createRoom').classList.remove('hidden');
            document.getElementById('joinRoom').classList.remove('hidden');
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('room')) {
                document.getElementById('joinCode').value = urlParams.get('room');
            }
            renderBossGrid();
        });

        // When a room is created or joined, show the main app and hide room controls
        function onRoomJoinedOrCreated() {
            document.getElementById('createRoom').classList.add('hidden');
            document.getElementById('joinRoom').classList.add('hidden');
            document.getElementById('roomInfo').classList.remove('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            renderBossGrid();
            showRoom();
        }

        // Utility function for NXPC conversion
        function nesoToNxpc(neso) {
            return (neso / 100000).toFixed(5).replace(/\.0+$/, '');
        }
    </script>
</body>
</html>
